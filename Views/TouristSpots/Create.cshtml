@model TourismWeb.Models.TouristSpot
@{
    ViewData["Title"] = "Thêm địa điểm du lịch mới";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<style>
    :root {
        --primary-color: #2563eb;
        --primary-hover: #1d4ed8;
        --secondary-color: #64748b;
        --success-color: #059669;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --light-bg: #f8fafc;
        --border-color: #cbd5e1;
        --input-bg: #ffffff;
        --shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --border-radius-md: 10px;
        --border-radius-lg: 16px;
    }

    .main-content {
        flex: 1;
        padding: 2rem;
    }

    .page-header {
        background: var(--input-bg);
        border-radius: var(--border-radius-lg);
        padding: 1.75rem 2rem;
        margin-bottom: 2.5rem;
        box-shadow: var(--shadow);
    }

    .page-title {
        display: flex;
        align-items: center;
        margin: 0;
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1.75rem;
    }

    .page-title i {
        margin-right: 0.875rem;
        padding: 0.625rem;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow);
        font-size: 1rem;
    }

    .form-card {
        background: var(--input-bg);
        border-radius: var(--border-radius-lg);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    .form-section {
        padding: 2rem 2.5rem;
    }

    .form-section+.form-section {
        border-top: 1px solid var(--border-color);
    }

    .form-section-title {
        color: var(--primary-color);
        font-weight: 600;
        font-size: 1.25rem;
        margin-bottom: 2rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
    }

    .form-section-title i {
        margin-right: 0.875rem;
        padding: 0.5rem;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
        border-radius: 8px;
        font-size: 0.875rem;
    }

    .mb-3-custom {
        margin-bottom: 1.5rem !important;
    }

    .form-control,
    .form-select {
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-md);
        /* Bo tròn tất cả các góc */
        padding: 0.8rem 1.1rem;
        transition: all 0.2s ease-in-out;
        background-color: var(--input-bg);
        color: #333;
        height: auto;
        font-size: 0.95rem;
        width: 100%;
        box-shadow: var(--shadow);
        /* Thêm shadow nhẹ cho input đứng một mình */
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15), var(--shadow);
        /* Giữ shadow khi focus */
        background-color: var(--input-bg);
    }

    textarea.form-control {
        min-height: 100px;
    }

    /* CSS cho input group vẫn cần thiết cho các trường khác */
    .input-group {
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow);
        width: 100%;
        display: flex;
        /* Quan trọng để input-group-text và form-control nằm ngang */
    }

    .input-group .input-group-text {
        background: var(--primary-color);
        /* Màu nền cho icon */
        color: white;
        border: 1px solid var(--primary-color);
        border-right: none;
        /* Bỏ border phải để liền với input */
        padding: 0.8rem 1rem;
        border-radius: var(--border-radius-md) 0 0 var(--border-radius-md);
        /* Bo góc trái */
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 50px;
        /* Chiều rộng tối thiểu cho phần icon */
        font-size: 0.9rem;
    }

    .input-group .form-control {
        border-radius: 0 var(--border-radius-md) var(--border-radius-md) 0;
        /* Bo góc phải */
        border-left: none;
        /* Bỏ border trái để liền với icon */
        box-shadow: none;
        /* Input trong group không cần shadow riêng */
        flex: 1 1 auto;
        /* Để input chiếm phần còn lại */
    }

    .image-preview-container {
        background: #f7f9fc;
        border: 2px dashed var(--border-color);
        border-radius: var(--border-radius-md);
        padding: 1rem;
        text-align: center;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
    }

    .image-preview-container:hover {
        border-color: var(--primary-color);
        background: #eff6ff;
    }

    .image-preview {
        max-width: 100%;
        max-height: 100%;
        border-radius: 8px;
        object-fit: contain;
    }

    .upload-placeholder {
        color: var(--secondary-color);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }

    .upload-placeholder i {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
        opacity: 0.7;
    }

    .upload-placeholder div {
        font-size: 0.8rem;
        font-weight: 500;
    }

    .btn {
        border-radius: var(--border-radius-md);
        padding: 0.875rem 1.5rem;
        font-weight: 500;
        transition: all 0.2s ease-in-out;
        border: none;
        position: relative;
        overflow: hidden;
        font-size: 0.95rem;
    }

    .btn-lg {
        padding: 1rem 2rem;
        font-size: 1rem;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(37, 99, 235, 0.25);
    }

    .btn-outline-secondary {
        border: 1px solid var(--border-color);
        color: var(--secondary-color);
        background: transparent;
    }

    .btn-outline-secondary:hover {
        background: var(--secondary-color);
        color: white;
        border-color: var(--secondary-color);
        transform: translateY(-2px);
    }

    .form-actions {
        background: #f8f9fa;
        padding: 1.75rem 2.5rem;
        border-top: 1px solid var(--border-color);
    }

    .alert {
        border-radius: var(--border-radius-md);
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }

    .alert-danger {
        background-color: #fef2f2;
        border-color: #fecaca;
        color: #991b1b;
    }

    .text-danger {
        color: var(--danger-color) !important;
        font-size: 0.8rem;
        margin-top: 0.35rem;
        display: block;
    }

    .form-text {
        color: #555;
        font-size: 0.8rem;
        margin-top: 0.3rem;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(4px);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(0, 0, 0, 0.1);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .form-label.label-on-left {
        margin-bottom: 0;
        padding-top: calc(0.8rem + 1px);
        text-align: right;
        padding-right: 15px;
    }

    .form-label.label-on-left.pt-0 {
        padding-top: 0;
    }

    media (max-width: 767.98px) {
        .main-content {
            padding: 1rem;
        }

        .page-header {
            padding: 1.25rem;
            margin-bottom: 1.5rem;
        }

        .page-title {
            font-size: 1.5rem;
        }

        .form-section {
            padding: 1.5rem;
        }

        .form-label.label-on-left {
            text-align: left;
            padding-top: 0;
            margin-bottom: 0.6rem;
            padding-right: 0;
        }

        .row.align-items-center>[class*="col-"],
        .row.align-items-start>[class*="col-"],
        .col-lg-5 .row>[class*="col-"] {
            flex: 0 0 100%;
            max-width: 100%;
        }
    }

    .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        border-radius: 0.2rem;
    }

    .input-group>.form-control-sm:not(:first-child) {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    .input-group>.input-group-prepend>.input-group-text,
    .input-group>.input-group-append>.input-group-text {
        padding: 0.25rem 0.5rem;
    }
</style>

<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
</div>

<div class="main-content">
    <div class="page-header">
        <h1 class="page-title">
            <i class="fas fa-plus-circle"></i>
            Thêm địa điểm du lịch mới
        </h1>
    </div>

    <div class="form-card">
        <form asp-action="Create" method="post" enctype="multipart/form-data" id="touristSpotForm">
            <div asp-validation-summary="ModelOnly" class="alert alert-danger mx-3 mt-3" role="alert"></div>

            <!-- Thông tin cơ bản -->
            <div class="form-section">
                <h4 class="form-section-title">
                    <i class="fas fa-info-circle"></i>
                    Thông tin cơ bản
                </h4>
                <div class="row">
                    <div class="col-lg-7">
                        <!-- Tên địa điểm -->
                        <div class="mb-3-custom">
                            <label asp-for="Name" class="form-label">Tên địa điểm <span
                                    class="text-danger">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="Nhập tên địa điểm du lịch" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                        <!-- Địa chỉ -->
                        <div class="mb-3-custom">
                            <label asp-for="Address" class="form-label">Địa chỉ <span
                                    class="text-danger">*</span></label>
                            <input asp-for="Address" class="form-control" placeholder="Nhập địa chỉ chi tiết" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>
                        <!-- Danh mục -->
                        <div class="mb-3-custom">
                            <label asp-for="CategoryId" class="form-label">Danh mục <span
                                    class="text-danger">*</span></label>
                            <select asp-for="CategoryId" class="form-select" asp-items="ViewBag.CategoryList">
                                <option value="">-- Chọn danh mục --</option>
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Phần Hình ảnh -->
                    <div class="col-lg-5">
                        <div class="mb-3-custom">
                            <div class="row mb-2 align-items-start">
                                <div class="col-md-4 col-lg-4">
                                    <label class="form-label label-on-left pt-0">Hình ảnh</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <div class="image-preview-container" style="height: 180px;">
                                        <img id="imagePreview" class="image-preview"
                                            src="@(string.IsNullOrEmpty(Model?.ImageUrl) ? "" : Model.ImageUrl)"
                                            alt="Xem trước ảnh"
                                            style="@(string.IsNullOrEmpty(Model?.ImageUrl) && (ViewBag.imageFilesCount == null || (int)ViewBag.imageFilesCount == 0) ? "display: none;" : "display: block;")" />
                                        <div id="uploadPlaceholder" class="upload-placeholder"
                                            style="@(string.IsNullOrEmpty(Model?.ImageUrl) && (ViewBag.imageFilesCount == null || (int)ViewBag.imageFilesCount == 0) ? "display: flex;" : "display: none;")">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            <div>Chọn ảnh</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-4 col-lg-4"></div>
                                <div class="col-md-8 col-lg-8">
                                    <div class="input-group">
                                        <!-- Input group cho file vẫn giữ lại để có thể style nút "Choose File" nếu muốn -->
                                        <input type="file" id="imageUploadFile" name="imageFiles"
                                            class="form-control form-control-sm" accept="image/*" multiple />
                                    </div>
                                    <span id="imageFileValidation" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 col-lg-4 align-self-center">
                                    <small class="form-text text-end d-block pe-2">Hoặc URL:</small>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input asp-for="ImageUrl" id="imageUrlInput" type="url"
                                        class="form-control form-control-sm" placeholder="Dán URL ảnh tại đây" />
                                    <span asp-validation-for="ImageUrl" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mb-3-custom">
                    <label asp-for="Description" class="form-label">Mô tả <span class="text-danger">*</span></label>
                    <textarea asp-for="Description" class="form-control" rows="5"
                        placeholder="Nhập mô tả chi tiết về địa điểm du lịch..."></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>
            </div>

            <!-- Thông tin bổ sung -->
            <div class="form-section">
                <h4 class="form-section-title">
                    <i class="fas fa-info"></i>
                    Thông tin bổ sung
                </h4>
                <div class="row mb-3-custom align-items-center">
                    <label asp-for="IdealVisitTime" class="col-md-3 col-lg-2 form-label label-on-left">Thời gian lý
                        tưởng</label>
                    <div class="col-md-9 col-lg-10">
                        <input asp-for="IdealVisitTime" type="text" class="form-control"
                            placeholder="VD: Tháng 3 - Tháng 5" />
                        <span asp-validation-for="IdealVisitTime" class="text-danger mt-1"></span>
                    </div>
                </div>
                <div class="row mb-3-custom align-items-center">
                    <label asp-for="AvailableServices" class="col-md-3 col-lg-2 form-label label-on-left">Dịch vụ có
                        sẵn</label>
                    <div class="col-md-9 col-lg-10">
                        <input asp-for="AvailableServices" type="text" class="form-control"
                            placeholder="VD: Khách sạn, Nhà hàng (cách nhau bởi dấu phẩy)" />
                        <span asp-validation-for="AvailableServices" class="text-danger mt-1"></span>
                    </div>
                </div>
                <div class="row mb-3-custom align-items-start">
                    <label asp-for="TravelTips" class="col-md-3 col-lg-2 form-label label-on-left pt-2">Mẹo du
                        lịch</label>
                    <div class="col-md-9 col-lg-10">
                        <textarea asp-for="TravelTips" class="form-control" rows="3"
                            placeholder="Nhập các mẹo du lịch, mỗi mẹo một dòng..."></textarea>
                        <span asp-validation-for="TravelTips" class="text-danger mt-1"></span>
                    </div>
                </div>
                <div class="row mb-3-custom align-items-center">
                    <label asp-for="MapEmbedUrl" class="col-md-3 col-lg-2 form-label label-on-left">Bản đồ (Google
                        Maps)</label>
                    <div class="col-md-9 col-lg-10">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-map-marked-alt"></i></span>
                            <input asp-for="MapEmbedUrl" type="url" class="form-control"
                                placeholder="Dán URL src từ iframe Google Maps" />
                        </div>
                        <span asp-validation-for="MapEmbedUrl" class="text-danger mt-1"></span>
                    </div>
                </div>
                <div class="row mb-3-custom align-items-center">
                    <label asp-for="VideoEmbedUrl" class="col-md-3 col-lg-2 form-label label-on-left">Video
                        (YouTube)</label>
                    <div class="col-md-9 col-lg-10">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fab fa-youtube"></i></span>
                            <input asp-for="VideoEmbedUrl" type="url" class="form-control"
                                placeholder="Dán URL src từ iframe YouTube" />
                        </div>
                        <span asp-validation-for="VideoEmbedUrl" class="text-danger mt-1"></span>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="form-actions">
                <div class="row gx-3">
                    <div class="col-md-6 mb-2 mb-md-0">
                        <a asp-action="Index" asp-controller="TouristSpots"
                            class="btn btn-outline-secondary w-100 btn-lg">
                            <i class="fas fa-arrow-left me-2"></i>Quay lại
                        </a>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="fas fa-save me-2"></i>Tạo địa điểm
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const fileInput = document.getElementById('imageUploadFile');
            const imagePreview = document.getElementById('imagePreview');
            const uploadPlaceholder = document.getElementById('uploadPlaceholder');
            const urlImageInput = document.getElementById('imageUrlInput');
            const defaultPlaceholderImage = "/images/default-spotImage.png";
            const imageFileValidationSpan = document.getElementById('imageFileValidation');

            function updateImagePreview(src) {
                if (src && src.trim() !== "") {
                    imagePreview.src = src;
                    imagePreview.style.display = 'block';
                    uploadPlaceholder.style.display = 'none';
                } else {
                    if (!fileInput.files || fileInput.files.length === 0) {
                        imagePreview.style.display = 'none';
                        uploadPlaceholder.style.display = 'flex';
                        imagePreview.src = '';
                    } else {
                        imagePreview.src = defaultPlaceholderImage;
                        imagePreview.style.display = 'block';
                        uploadPlaceholder.style.display = 'none';
                    }
                }
            }

            let initialImageSrc = imagePreview.getAttribute('src');
            if (!initialImageSrc || initialImageSrc === defaultPlaceholderImage || initialImageSrc.trim() === "") {
                if (!urlImageInput.value && (!fileInput.files || fileInput.files.length === 0)) {
                    imagePreview.style.display = 'none';
                    uploadPlaceholder.style.display = 'flex';
                } else if (urlImageInput.value) {
                    updateImagePreview(urlImageInput.value);
                }
            } else {
                imagePreview.style.display = 'block';
                uploadPlaceholder.style.display = 'none';
            }

            fileInput.addEventListener('change', function (e) {
                imageFileValidationSpan.textContent = '';
                const files = e.target.files;
                if (files && files.length > 0) {
                    const file = files[0];
                    if (file.size > 5 * 1024 * 1024) {
                        imageFileValidationSpan.textContent = 'Kích thước file không được vượt quá 5MB.';
                        fileInput.value = '';
                        updateImagePreview(urlImageInput.value);
                        return;
                    }
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
                    if (!allowedTypes.includes(file.type)) {
                        imageFileValidationSpan.textContent = 'Chỉ chấp nhận file ảnh: .jpg, .jpeg, .png, .gif.';
                        fileInput.value = '';
                        updateImagePreview(urlImageInput.value);
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        updateImagePreview(event.target.result);
                    };
                    reader.readAsDataURL(file);
                } else {
                    updateImagePreview(urlImageInput.value);
                }
            });

            urlImageInput.addEventListener('input', function () {
                if (!fileInput.files || fileInput.files.length === 0) {
                    updateImagePreview(this.value);
                }
            });

            const form = document.getElementById('touristSpotForm');
            form.addEventListener('submit', function (e) {
                showLoading(true);
            });

            function showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }
        });
    </script>
}